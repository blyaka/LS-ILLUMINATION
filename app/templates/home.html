{% extends '_base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/home.css' %}" />
{% endblock %}

{% block content %}

<script src="{% static 'vendor/hls/hls.min.js' %}"></script>

<section class="ls-hero" data-nofly>
  {% if hero_video %}
  <div class="ls-hero__media-wrap">
    <video id="heroVideo" class="ls-hero__media" {% if hero_video.poster %}poster="{{ hero_video.poster.url }}" {%endif%} autoplay muted loop playsinline></video>
  </div>

  <script>
    (function () {
      const src = "{{ hero_video.m3u8_url }}";
      const el = document.getElementById('heroVideo');

      function playNative() { el.src = src; }

      if (el.canPlayType('application/vnd.apple.mpegurl')) {
        playNative();
      } else if (window.Hls && Hls.isSupported()) {
        const h = new Hls({ maxBufferLength: 4, autoStartLoad: true });
        h.loadSource(src);
        h.attachMedia(el);
      } else {
        playNative();
      }
    })();
  </script>
  {% endif %}



  <div class="ls-hero__overlay-top"></div>
  <div class="ls-hero__overlay-bottom"></div>

  <div class="ls-hero__content">
    <h1 class="ls-hero__title">Москва</h1>
    <p class="ls-hero__subtitle">Новогоднее оформление всей России</p>
  </div>

  <div class="ls-hero__stats">
    <div class="ls-hero__stat">
      <span>16</span><small>лет работы</small>
    </div>
    <div class="ls-hero__stat">
      <span>250+</span><small>проектов</small>
    </div>
    <div class="ls-hero__stat">
      <span>300+</span><small>человек</small>
    </div>
  </div>

  <button class="ls-hero__pp" id="ppBtn" aria-label="Воспроизвести/Пауза">
    <svg class="pp-icon pp-play" viewBox="0 0 24 24" width="34" height="34" aria-hidden="true">
      <path d="M8 5v14l11-7-11-7z" fill="currentColor" />
    </svg>
    <svg class="pp-icon pp-pause" viewBox="0 0 24 24" width="34" height="34" aria-hidden="true">
      <path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor" />
    </svg>
  </button>

  <a href="" class="pdf-button" id="pdfBtn">
      <svg width="29" height="33">
        <use xlink:href="{% static 'images/icons.svg' %}#icon-pdf"></use>
      </svg>
    Запросить каталог PDF
  </a>
</section>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.querySelector('.ls-hero__stats');
    if(!el) return;

    const io = new IntersectionObserver(([e]) => {
      if (e.isIntersecting){
        el.classList.add('is-inview');
        io.disconnect();
      }
    }, { threshold: 0.3 });

    io.observe(el);
  });
</script>






<!-- LIQUD GLASS -->
<!-- <svg style="display: none">
  <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%" filterUnits="objectBoundingBox">
    <feTurbulence type="fractalNoise" baseFrequency="0.01 0.01" numOctaves="1" seed="1" result="turbulence" />

    <feComponentTransfer in="turbulence" result="mapped">
      <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
      <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
      <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
    </feComponentTransfer>

    <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

    <feSpecularLighting in="softMap" surfaceScale="5" specularConstant="1" specularExponent="100" lighting-color="white"
      result="specLight">
      <fePointLight x="-200" y="-200" z="300" />
    </feSpecularLighting>

    <feComposite in="specLight" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litImage" />

    <feDisplacementMap in="SourceGraphic" in2="softMap" scale="75" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg> -->





<!-- РАЗДЕЛ ПОРТФОЛИО -->
<section class="main" data-spawn="5">
    <h1> Портфолио </h1>

    <div class="grid">
      {% for cat in categories %}
        <a class="card-link" href="{% url 'portfolio' slug=cat.slug %}">
            <div class="card">
                <div class="card-border"></div>

                <div class="card-image">
                  {% if cat.photo.url %}
                  <img src="{{ cat.photo.url }}" alt="{{ cat.name }}" />
                  {% endif %}
                </div>
                <div class="card-text">
                    <p>{{ cat.first_word }}<br>{{ cat.rest_words }}</p>
                </div>
            </div>
        </a>
      {% endfor %}
        </div>
</section>



<!-- Скрпиты карточек -->
<script>
  (() => {
      const norm360 = v => ((v % 360) + 360) % 360;
      document.querySelectorAll('.card').forEach(card => {
          let raf = 0, last = 0, vis = 0, target = 0, hover = false;
          const link = card.closest('.card-link');

          function angleTo(el, x, y) {
              const r = el.getBoundingClientRect();
              const cx = r.left + r.width / 2, cy = r.top + r.height / 2;
              let deg = Math.atan2(y - cy, x - cx) * 180 / Math.PI;
              if (deg < 0) deg += 360;
              return (deg + 90) % 360;
          }

          function step(ts) {
              const dt = (ts - (last || ts)) / 1000; last = ts;
              const d = ((target - vis + 540) % 360) - 180;
              vis = norm360(vis + d * Math.min(1, dt * 12));
              const v = vis + 'deg';
              card.style.setProperty('--base-angle', v);
              if (link) link.style.setProperty('--base-angle', v);
              if (hover) raf = requestAnimationFrame(step); else raf = 0;
          }

          card.addEventListener('mouseenter', () => { hover = true; if (!raf) raf = requestAnimationFrame(step); }, { passive: true });
          card.addEventListener('mouseleave', () => { hover = false; }, { passive: true });
          card.addEventListener('mousemove', e => {
              const rect = card.getBoundingClientRect();
              const x = e.clientX - rect.left, y = e.clientY - rect.top;
              card.style.setProperty('--x', x + 'px');
              card.style.setProperty('--y', y + 'px');
              target = angleTo(card, e.clientX, e.clientY);
              if (!raf) raf = requestAnimationFrame(step);
          }, { passive: true });
      });
  })();
</script>













<section class="cw-videos" id="videos" data-spawn="3">
  <h2 class="cw-videos__title">Видеогалерея</h2>

  <div class="cw-videos__marquee" id="videosMarquee" aria-label="Лента видео, автопрокрутка">
    <div class="cw-videos__track">
      {% for v in more_videos %}
      <button class="v-card" type="button" {% if v.m3u8_url %}
        data-src="{{ v.m3u8_url }}"
        data-title="{{ v.name|default:'Видео' }}"
        data-poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}"
        {% else %} disabled aria-disabled="true" title="Видео ещё не готово" {% endif %}>
        <div class="v-card__thumb">
          <img src="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}"
               alt="{{ v.name|default:'Видео' }}" loading="lazy" />
          <span class="v-card__play" aria-hidden="true"></span>
        </div>
        <span class="v-card__title">{{ v.name|default:"Видео" }}</span>
      </button>
      {% endfor %}

      {% for v in more_videos %}
      <button class="v-card" type="button" {% if v.m3u8_url %}
        data-src="{{ v.m3u8_url }}"
        data-title="{{ v.name|default:'Видео' }}"
        data-poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}"
        {% else %} disabled aria-disabled="true" title="Видео ещё не готово" {% endif %}>
        <div class="v-card__thumb">
          <img src="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}"
               alt="{{ v.name|default:'Видео' }}" loading="lazy" />
          <span class="v-card__play" aria-hidden="true"></span>
        </div>
        <span class="v-card__title">{{ v.name|default:"Видео" }}</span>
      </button>
      {% endfor %}
    </div>
  </div>

  <div class="v-modal" id="vModal" hidden>
    <div class="v-modal__backdrop" data-close></div>
    <div class="v-modal__dialog" role="dialog" aria-modal="true" aria-label="Видеоплеер">
      <button class="v-modal__close" type="button" data-close aria-label="Закрыть">×</button>
      <div class="v-modal__frame"><video id="vPlayer" controls playsinline preload="none"></video></div>
      <div class="v-modal__title" id="vTitle"></div>
    </div>
  </div>
</section>



<script>
  (function () {
    const marquee = document.getElementById('videosMarquee');
    if (!marquee) return;
    const track = marquee.querySelector('.cw-videos__track');
    if (!track) return;

    const anims = track.getAnimations ? track.getAnimations() : [];
    const anim = anims && anims[0] ? anims[0] : null;

    let targetRate = 1;
    let rate = 1;

    function tick() {
      rate += (targetRate - rate) * 0.08;
      if (anim && typeof anim.playbackRate === 'number') {
        anim.playbackRate = Math.max(0.01, rate);
      } else {
        track.style.animationPlayState = rate < 0.2 ? 'paused' : 'running';
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    marquee.addEventListener('mouseenter', () => { targetRate = 0; }, { passive: true });
    marquee.addEventListener('mouseleave', () => { targetRate = 1; }, { passive: true });

    const modal = document.getElementById('vModal');
    const observer = new MutationObserver(() => {
      const isOpen = !modal.hasAttribute('hidden');
      targetRate = isOpen ? 0 : 1;
    });
    observer.observe(modal, { attributes: true, attributeFilter: ['hidden'] });
  })();
</script>

<script>
  (() => {
    if (window.__videoModalInit) return;
    window.__videoModalInit = true;

    const modal = document.getElementById('vModal');
    const player = document.getElementById('vPlayer');
    const titleEl = document.getElementById('vTitle');
    let hls = null;

    function attach(src, poster) {
      return new Promise((resolve) => {
        const url = String(src || '').trim();
        if (!url) return resolve(false);

        try { player.pause(); } catch { }
        if (hls) { try { hls.destroy(); } catch { } hls = null; }
        player.removeAttribute('src'); player.load();

        if (poster) player.setAttribute('poster', poster); else player.removeAttribute('poster');

        const onReady = () => {
          const onPlaying = () => { player.removeAttribute('poster'); player.removeEventListener('playing', onPlaying); };
          player.addEventListener('playing', onPlaying, { once: true });
          resolve(true);
        };

        if (player.canPlayType('application/vnd.apple.mpegurl')) {
          player.src = url;
          player.addEventListener('canplay', onReady, { once: true });
          return;
        }

        if (window.Hls && Hls.isSupported()) {
          hls = new Hls({ maxBufferLength: 10, autoStartLoad: true });
          hls.on(Hls.Events.MANIFEST_PARSED, onReady);
          hls.on(Hls.Events.ERROR, (ev, data) => {

            if (data?.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                default: try { hls.destroy(); } catch { }
              }
            }
          });
          hls.loadSource(url);
          hls.attachMedia(player);
          return;
        }

        player.src = url;
        player.addEventListener('canplay', onReady, { once: true });
      });
    }

    async function open(src, poster, title) {
      titleEl.textContent = title || '';
      modal.hidden = false;
      document.body.style.overflow = 'hidden';

      const ready = await attach(src, poster);
      if (!ready) return;

      player.muted = true;
      try { await player.play(); } catch { }
    }

    function close() {
      try { player.pause(); } catch { }
      if (hls) { try { hls.destroy(); } catch { } hls = null; }
      player.removeAttribute('src'); player.load();
      modal.hidden = true;
      document.body.style.overflow = '';
      window.dispatchEvent(new Event('video-player:close'));
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.v-card[data-src], .v-open[data-src]');
      if (btn) {
        e.preventDefault();
        open(btn.dataset.src, btn.dataset.poster, btn.dataset.title);
      }
      if (e.target.hasAttribute('data-close')) close();
    });


    document.addEventListener('keydown', (e) => {
      if (!modal.hidden && e.code === 'Escape') close();
    });

    modal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) close();
    });
  })();
</script>




<section class="cw-seq" id="seq" data-nofly>
  <div class="cw-seq__sticky">
    <canvas id="seqCanvas" aria-label="Scroll sequence"></canvas>

    <!-- Overlay -->
    <div class="seq-ov">
      <div class="seq-fade seq-fade--top"></div>
      <div class="seq-fade seq-fade--bottom"></div>

      <div class="seq-copy" id="seqCopy">
        <span class="seq-kicker reveal">Фонтан</span>
        <h2 class="seq-title reveal">«ТЕАТРАЛЬНЫЙ»</h2>
        <p class="seq-desc reveal">
          Где дети считают звёзды.<br />
          Где взрослые снова верят в чудо.<br />
          Где вместе — теплее.
        </p>

        <p class="seq-desc2 reveal">
          LED PRO — экономичнее. <br>
          Безопасные материалы, IP65. <br>
          Надёжно в снег и ветер.
        </p>
      </div>

      <!-- Артикул: слева гаснет -->
      <div class="seq-art seq-art--right" id="artL">
        <span class="dot"></span> <span>Арт. 1337</span>
      </div>
      <!-- Артикул: справа появляется -->
      <div class="seq-art seq-art--left" id="artR">
        <span class="dot"></span> <span>Арт. 1337</span>
      </div>

      <!-- Схема: появляется на финальных кадрах -->
      <img class="seq-scheme" id="seqScheme" src="{% static 'images/scheme.png' %}" alt="Схема" />

      <!-- Новая картинка с анимацией -->
      <img class="seq-img" id="seqImg" src="{% static 'images/scheme-up.png' %}" alt="Схема" />
    </div>
  </div>
</section>



<script>
  (() => {
    const s = document.getElementById('seq');
    const c = document.getElementById('seqCanvas');
    const x = c.getContext('2d', { alpha: false });
    const d = Math.min(2, window.devicePixelRatio || 1);

    const copyStart = document.getElementById('seqCopy');
    const ov = document.querySelector('.seq-ov');
    const artL = document.getElementById('artL');
    const artR = document.getElementById('artR');
    const scheme = document.getElementById('seqScheme');
    const seqImg = document.getElementById('seqImg');

    const fTop = ov.querySelector('.seq-fade--top');
    const fBot = ov.querySelector('.seq-fade--bottom');


    const k1 = copyStart.querySelector('.seq-kicker');
    const t1 = copyStart.querySelector('.seq-title');
    const d1 = copyStart.querySelector('.seq-desc');
    const d2orig = copyStart.querySelector('.seq-desc2');

    const copyFinal = copyStart.cloneNode(true);
    copyFinal.id = 'seqCopyFinal';
    copyFinal.classList.add('seq-copy--final');
    copyFinal.querySelector('.seq-desc')?.remove();
    d2orig?.remove();
    ov.appendChild(copyFinal);

    const k2 = copyFinal.querySelector('.seq-kicker');
    const t2 = copyFinal.querySelector('.seq-title');
    const d2 = copyFinal.querySelector('.seq-desc2');

    [k1, t1, d1, k2, t2, d2].forEach(el => { el.classList.add('reveal'); });

    function resize() {
      c.width = Math.floor(innerWidth * d);
      c.height = Math.floor(innerHeight * d);
      c.style.width = '100vw'; c.style.height = '100vh';
      x.setTransform(d, 0, 0, d, 0, 0);
      snap(cur);
    }

    const N = 60;
    const U = i => `/static/images/sequence/final_00000_${String(i).padStart(5, '0')}.webp`;
    const G = new Array(N);
    let tgt = 0, cur = 0, raf = 0, last = -1;

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const smooth = (a, b, t) => clamp((t - a) / (b - a), 0, 1);

    function draw(img) {
      const cw = c.width / d, ch = c.height / d;
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const s = Math.max(cw / iw, ch / ih), w = iw * s, h = ih * s;
      x.clearRect(0, 0, cw, ch);
      x.drawImage(img, (cw - w) / 2, (ch - h) / 2, w, h);
    }

    function snap(f) {
      const idx = clamp(Math.round(f), 0, N - 1);
      if (idx === last) return;
      const im = G[idx];
      if (!im || !im.complete) return;
      last = idx; draw(im);
    }

    let entered = false;

    function progressFromScroll() {
      const r = s.getBoundingClientRect();
      const m = s.offsetHeight - innerHeight;
      const y = Math.min(m, Math.max(0, -r.top));
      tgt = m ? (y / m) * (N - 1) : 0;

      const SHOW_AT = 0.85;                     // позже триггерим: 85% экрана
      const MIN_VIS_VH = 0.55;                  // должно быть видно >=55% ВЬЮПОРТА

      const topReached = r.top <= innerHeight * SHOW_AT;
      const visiblePx = Math.min(innerHeight, r.bottom) - Math.max(0, r.top);
      const enoughInView = visiblePx >= innerHeight * MIN_VIS_VH;

      if (!entered && topReached && enoughInView) {
        entered = true;
        [k1, t1, d1].forEach(el => el.classList.add('show'));
      }

      if (entered && (r.bottom <= 0 || r.top >= innerHeight)) {
        entered = false;
        [k1, t1, d1, k2, t2, d2].forEach(el => el.classList.remove('show'));
      }

      if (!raf) raf = requestAnimationFrame(loop);
    }


    function updateOverlay(p) {
      const topA = 1 - smooth(0.00, 0.08, p);  // виден только в самом начале
      const botA =       smooth(0.92, 1.00, p); // виден только в самом конце
      if (fTop) fTop.style.opacity = topA.toFixed(3);
      if (fBot) fBot.style.opacity = botA.toFixed(3);

      artL.style.opacity = 1 - smooth(0.40, 0.55, p);
      artR.style.opacity = smooth(0.55, 0.70, p);

      const vis = smooth(0.80, 0.95, p);
      scheme.style.opacity = vis;
      scheme.style.transform = `translateY(${16 * (1 - vis)}px)`;
      seqImg.classList.toggle('show', p > 0.80);

      if (!entered) {
        [k1, t1, d1, k2, t2, d2].forEach(el => el.classList.remove('show'));
        return;
      }

      const hideStart = smooth(0.48, 0.60, p) > 0.5;
      [k1, t1, d1].forEach(el => el.classList.toggle('show', !hideStart));

      const showFinal = smooth(0.58, 0.70, p) > 0.5;
      [k2, t2, d2].forEach(el => el.classList.toggle('show', showFinal));

      k2.classList.toggle('right', p >= 0.62);
    }


    function loop() {
      raf = 0;
      cur += (tgt - cur) * 0.2;
      snap(cur);
      updateOverlay(cur / (N - 1));
      if (Math.abs(tgt - cur) > 0.001) raf = requestAnimationFrame(loop);
    }

    G[0] = new Image(); G[0].src = U(0);
    G[0].onload = () => { snap(0); updateOverlay(0); };
    for (let i = 1; i < N; i++) { G[i] = new Image(); G[i].decoding = 'async'; G[i].src = U(i); }

    resize();
    addEventListener('resize', () => { resize(); progressFromScroll(); });
    addEventListener('scroll', progressFromScroll, { passive: true });
    progressFromScroll();
  })();
</script>















{% for v in block_videos %}
{% if forloop.counter|divisibleby:2 %}
<section class="cw-split right" data-spawn="2">
  <aside class="cw-split__aside">
    <h2 class="cw-split__title">{{ v.name|default:"Видео" }}</h2>
    <p class="cw-split__desc">{{ v.description|default:"" }}</p>
    {% if v.m3u8_url %}




    <a class="btn-link v-open cw-split__btn" 
      data-src="{{ v.m3u8_url }}" 
      data-title="{{ v.name|default:'Видео' }}"
      data-poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}">
      <div class="btn-glow">
        <div class="btn-border"></div>
        <div class="btn-text"><p>Смотреть полностью</p></div>
      </div>
    </a>


    {% else %}
    <a class="btn-link v-open cw-split__btn" disabled>
      <div class="btn-glow">
        <div class="btn-border"></div>
        <div class="btn-text"><p>Обрабатывается ...</p></div>
      </div>
    </a>
    {% endif %}


  </aside>
  <div class="cw-split__media">
    <video class="cw-split__video" preload="none" muted loop playsinline
      poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/hero-bg.png' %}{% endif %}"
      data-src="{{ v.m3u8_url }}" data-kind="hls"></video>
  </div>
</section>


{% else %}
<section class="cw-split" data-spawn="2">
  <div class="cw-split__media">
    <video class="cw-split__video" preload="none" muted loop playsinline
      poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/hero-bg.png' %}{% endif %}"
      data-src="{{ v.m3u8_url }}" data-kind="hls"></video>
  </div>
  <aside class="cw-split__aside">
    <h2 class="cw-split__title">{{ v.name|default:"Видео" }}</h2>
    <p class="cw-split__desc">{{ v.description|default:"" }}</p>
    {% if v.m3u8_url %}


    <a class="btn-link v-open cw-split__btn" 
      data-src="{{ v.m3u8_url }}" 
      data-title="{{ v.name|default:'Видео' }}"
      data-poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}">
      <div class="btn-glow">
        <div class="btn-border"></div>
        <div class="btn-text"><p>Смотреть полностью</p></div>
      </div>
    </a>


    {% else %}
    <a class="btn-link v-open cw-split__btn" disabled>
      <div class="btn-glow">
        <div class="btn-border"></div>
        <div class="btn-text"><p>Обрабатывается ...</p></div>
      </div>
    </a>
    {% endif %}


  </aside>
</section>
{% endif %}
{% endfor %}


<script>
  (() => {
    const vids = document.querySelectorAll('.cw-split__video[data-src]');
    const st = new WeakMap();
    const DETACH = 2000;
    const NEAR_MARGIN = '800px 0px';
    let modalSrc = null;

    async function attach(v) {
      if (modalSrc && v.dataset.src === modalSrc) return;

      const s = st.get(v) || {};
      const src = v.dataset.src;
      if (!src) return;

      v.muted = true; v.loop = true; v.playsInline = true;

      if (!s.againBound) {
        v.addEventListener('ended', () => { v.currentTime = 0; v.play().catch(() => {}); });
        s.againBound = true;
      }

      if (!s.attached) {
        if (v.canPlayType('application/vnd.apple.mpegurl')) {
          v.src = src; s.hls = null; s.attached = true;
        } else if (window.Hls && Hls.isSupported()) {
          const h = new Hls({ maxBufferLength: 6, autoStartLoad: true });
          h.loadSource(src); h.attachMedia(v); s.hls = h; s.attached = true;
        } else {
          v.src = src; s.hls = null; s.attached = true;
        }
        st.set(v, s);
      }
      try { await v.play(); } catch {}
    }

    function pause(v) { try { v.pause(); } catch {} }

    function detach(v) {
      const s = st.get(v);
      if (!s || !s.attached) return;
      pause(v);
      if (s.hls) { try { s.hls.destroy(); } catch {} }
      v.removeAttribute('src'); v.load();
      s.attached = false; s.hls = null;
      st.set(v, s);
    }

    const pausedByModal = new WeakSet();

    function pauseBgVideos() {
      vids.forEach(v => {
        if (!v.paused) { pause(v); pausedByModal.add(v); }
      });
    }

    function resumeBgVideos() {
      vids.forEach(v => {
        if (!pausedByModal.has(v)) return;
        const r = v.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;
        const near = (r.bottom > -800) && (r.top < vh + 800);
        if (near) attach(v);
        pausedByModal.delete(v);
      });
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.v-open[data-src], .v-card[data-src]');
      if (!btn) return;

      modalSrc = btn.dataset.src || null;
      pauseBgVideos();

      const host = btn.closest('.cw-split');
      const cand = host ? host.querySelector('.cw-split__video[data-src]') : null;
      if (cand && cand.dataset.src === modalSrc) detach(cand);
    });

    window.addEventListener('video-player:close', () => {
      const prev = modalSrc;
      modalSrc = null;
      resumeBgVideos();

      if (prev) {
        vids.forEach(v => {
          if (v.dataset.src === prev) {
            const r = v.getBoundingClientRect();
            const vh = window.innerHeight || document.documentElement.clientHeight;
            const near = (r.bottom > -800) && (r.top < vh + 800);
            if (near) attach(v);
          }
        });
      }
    });

    const io = new IntersectionObserver((entries) => {
      const vh = window.innerHeight || document.documentElement.clientHeight;
      for (const e of entries) {
        const v = e.target;
        if (e.isIntersecting) {
          if (modalSrc && v.dataset.src === modalSrc) { pause(v); continue; }
          attach(v);
          continue;
        }
        const r = e.boundingClientRect;
        const far = (r.bottom < -DETACH) || (r.top > vh + DETACH);
        if (far) detach(v); else pause(v);
      }
    }, { root: null, rootMargin: NEAR_MARGIN, threshold: 0 });

    vids.forEach(v => { st.set(v, { attached:false, hls:null, againBound:false }); io.observe(v); });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) return;
      vids.forEach(v => {
        if (modalSrc && v.dataset.src === modalSrc) return;
        const r = v.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;
        const near = (r.bottom > -800) && (r.top < vh + 800);
        if (near) attach(v);
      });
    });
  })();
</script>





<section class="cw-news" id="news" data-spawn="2">
  <h2 class="cw-news__title">Новости</h2>

  <div class="news-wrap">
    <button class="news-arrow news-arrow--prev" aria-label="Назад"></button>

    <!-- Левое превью -->
    <figure class="news-side news-side--left">
      <img id="newsPrevImg" src="{% static 'images/portfolio.jpg' %}" alt="">
    </figure>

    <!-- Центральная карточка -->
    <article class="news-main" aria-live="polite">
      <figure class="news-main__media">
        <span class="news-date" id="newsDate">{{ news.0.created_at|date:"d E Y"|upper }}</span>
        <img id="newsImg" src="{{ news.0.image.url }}" alt="">
      </figure>
      <aside class="news-main__aside">
        <h3 class="news-title" id="newsTitle">{{ news.0.title|linebreaksbr }}</h3>
        <p class="news-desc" id="newsDesc">
          {{ news.0.text|truncatewords:25 }}
        </p>

        <a class="btn-link news-btn" href="#" id="newsLink">
        <div class="btn-glow">
          <div class="btn-border"></div>
          <div class="btn-text"><p>Читать далее</p></div>
        </div>
        </a>

      </aside>
    </article>

    <!-- Правое превью -->
    <figure class="news-side news-side--right">
      {% if news|length > 1 %}
      <img id="newsNextImg" src="{{ news.1.image.url }}" alt="">
      {% endif %}
    </figure>

    <button class="news-arrow news-arrow--next" aria-label="Вперёд"></button>
  </div>

  <!-- Данные для слайдера -->
  <script id="newsData" type="application/json">
    [
      {% for n in news %}
      {
        "date":"{{ n.created_at|date:'d E Y'|upper }}",
        "title":"{{ n.title|escapejs }}",
        "desc":"{{ n.text|truncatewords:30|escapejs }}",
        "img":"{{ n.image.url }}",
        "body":"{{ n.text|linebreaksbr|escapejs }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  </script>

</section>

<!-- Модалка новостей -->
<div class="news-modal" id="newsModal" hidden>
  <div class="news-modal__backdrop" data-close></div>
  <div class="news-modal__dialog" role="dialog" aria-modal="true" aria-label="Новость">
    <button class="news-modal__close" type="button" data-close aria-label="Закрыть">×</button>

    <h3 class="news-modal__title" id="nmTitle"></h3>
    <div class="news-modal__date" id="nmDate"></div>

    <figure class="news-modal__media">
      <img id="nmImg" src="" alt="">
    </figure>

    <div class="news-modal__body" id="nmBody"></div>

    <!-- <button class="news-modal__btn" type="button" data-close>
      Закрыть
    </button> -->

    <a class="btn-link" href="#" data-close>
      <div class="btn-glow">
        <div class="btn-border"></div>
        <div class="btn-text"><p>Закрыть</p></div>
      </div>
    </a>

  </div>
</div>




<section class="cw-trust" id="trust" data-spawn="2">
  <h2 class="cw-trust__title">Нам доверяют</h2>

  <div class="trust-view" id="trustView">
    <div class="trust-track" id="trustTrack">
      <div class="trust-item"><img src="{% static 'logos/moscow.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/spb.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/khimki.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/klin.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/labytnangi.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/nadym.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/klin.png' %}" alt=""></div>
    </div>
  </div>
</section>



<script>
  (() => {
    const view = document.getElementById('trustView');
    const track = document.getElementById('trustTrack');
    if (!view || !track) return;

    let SPEED = 1;
    let offset = 0;
    let raf = 0;

    track.innerHTML += track.innerHTML;
    const totalWidth = track.scrollWidth / 2;

    function frame() {
      offset -= SPEED;
      if (offset <= -totalWidth) offset = 0;
      track.style.transform = `translate3d(${offset}px,0,0)`;
      raf = requestAnimationFrame(frame);
    }

    function start() {
      if (raf) return;
      raf = requestAnimationFrame(frame);
    }

    function stop() {
      cancelAnimationFrame(raf);
      raf = 0;
    }

    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) start();
        else stop();
      }
    }, { root: null, rootMargin: '100px' });
    io.observe(view);

    view.addEventListener('mouseenter', () => SPEED = 0);
    view.addEventListener('mouseleave', () => SPEED = 1);

  })();

</script>




<section class="cw-contacts" id="contacts" aria-label="Контакты" data-nofly>

  <div class="cw-contacts__wrap">
    <!-- Левая колонка: форма -->
    <div class="ct-form">
      <p>Контакты</p>
      <h2 class="ct-title">Мы на связи!</h2>
      <p class="ct-sub">Оставьте заявку или свяжитесь с нами</p>

      <form class="ct-grid-last" method="post" action="{% url 'req_submit' %}">
        {% csrf_token %}
        <input type="hidden" name="hp" value="">
        <input type="hidden" name="ts" value="{{ now_ts|default:0 }}">

        <label class="ct-field">
          <input id="name-bot" type="text" name="name" placeholder="Ваше имя*" required>
        </label>

        <label class="ct-field">
          <input type="email" name="email" placeholder="Ваш E-mail*" required>
        </label>

        <label class="ct-field">
          <input id="phone-bot" type="tel" name="phone" inputmode="tel" placeholder="Ваш телефон*" required>
        </label>

        <label class="ct-area">
          <textarea name="message" rows="6" placeholder="Ваше сообщение"></textarea>
        </label>


        <!-- <a class="glow-btn" type="submit">
          <div class="glass-btn">
            <p>Оставить заявку</p>
          </div>
        </a> -->

        <button class="btn-link ct-btn" type="submit">
          <div class="btn-glow">
            <div class="btn-border"></div>
            <div class="btn-text"><p>Оставить заявку</p></div>
          </div>
        </button>

      </form>
    </div>


    <script>
      (function () {
        var f = document.querySelector('.ct-grid-last');
        if (!f) return;
        var ts = f.querySelector('input[name="ts"]');
        if (ts && (!ts.value || ts.value === "0")) ts.value = Math.floor(Date.now() / 1000);
      })();
    </script>

    <script>
      (() => {
        const n = document.getElementById('name-bot');

        n.addEventListener('input', () => {
          n.value = n.value.replace(/[0-9]/g, '');
        });
      })();
    </script>


    <script>
      (() => {
        const input = document.getElementById('phone-bot');

        input.addEventListener('input', () => {
          let v = input.value.replace(/\D/g, '');
          if (!v) { input.value = ''; return; }

          if (v[0] === '7') {
            v = '7' + v.slice(1);
            input.value = format(v, true);
          }
          else if (v[0] === '8') {
            input.value = format(v, false);
          }
          else {
            input.value = format(v, true);
          }
        });

        function format(digits, plus) {
          const p = digits.padEnd(11, '_').slice(0, 11);
          const part1 = p.slice(1, 4);
          const part2 = p.slice(4, 7);
          const part3 = p.slice(7, 9);
          const part4 = p.slice(9, 11);

          return (plus ? '+7' : '8') +
            ` (${part1}) ${part2}-${part3}-${part4}`.replace(/[_-]+$/, '');
        }
      })();
    </script>

    <!-- Правая колонка: контакты -->
    <aside class="ct-info">
      <ul class="ct-list">
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="28" height="28">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-phone"></use>
            </svg>
          </span>
          <a href="tel:+78126420365">+7 (812) 642-03-65</a>
        </li>
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="28" height="26">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-mail"></use>
            </svg>
          </span>
          <a href="mailto:info@multidekor.ru">info@multidekor.ru</a>
        </li>
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="27" height="32">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-location"></use>
            </svg>
          </span>
          г. Санкт-Петербург, улица Ломоносова, 28
        </li>
      </ul>

      <div class="hours-container">
        <p>Время работы:</p>

        <div class="ct-hours">
          <div class="ct-hours__ico" aria-hidden="true">
            <svg width="28" height="28">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-time"></use>
            </svg>
          </div>
          <div class="ct-hours__text">
            <div>Пн-Пт с 10:00 до 18:00</div>
            <div class="muted">Сб-Вс — выходные дни</div>
          </div>
        </div>
      </div>
    </aside>
  </div>
  
</section>





<script>
  (() => {
    const data = JSON.parse(document.getElementById('newsData').textContent);
    let i = 0;

    const img = document.getElementById('newsImg');
    const dateEl = document.getElementById('newsDate');
    const titleEl = document.getElementById('newsTitle');
    const descEl = document.getElementById('newsDesc');
    const prevImgEl = document.getElementById('newsPrevImg');
    const nextImgEl = document.getElementById('newsNextImg');

    const modal = document.getElementById('newsModal');
    const nmTitle = document.getElementById('nmTitle');
    const nmDate = document.getElementById('nmDate');
    const nmImg = document.getElementById('nmImg');
    const nmBody = document.getElementById('nmBody');

    const render = async () => {
      const cur = data[i];
      const prev = data[(i - 1 + data.length) % data.length];
      const next = data[(i + 1) % data.length];

      const im = new Image();
      im.decoding = 'async';
      im.src = cur.img;
      await im.decode().catch(() => { });
      img.src = im.src;

      dateEl.innerHTML = cur.date;
      titleEl.innerHTML = (cur.title || '').replace(/\n/g, '<br>');
      descEl.textContent = cur.desc || '';

      if (prevImgEl) prevImgEl.src = prev.img;
      if (nextImgEl) nextImgEl.src = next.img;
    };


    function openModal(idx) {
      if (!modal) return;
      const n = data[idx] || {};
      nmTitle.innerHTML = (n.title || '').replace(/\n/g, '<br>');
      nmDate.innerHTML = n.date || '';
      nmImg.src = n.img || img.src;
      nmImg.alt = (n.title || '').replace(/<[^>]+>/g, '').trim() || 'Новость';
      nmBody.innerHTML = n.body && n.body.trim()
        ? n.body
        : (n.desc ? `<p>${n.desc}</p>` : '');

      modal.hidden = false;
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      if (!modal) return;
      modal.hidden = true;
      document.body.style.overflow = '';
    }

    document.querySelector('.news-arrow--prev')?.addEventListener('click', () => { i = (i - 1 + data.length) % data.length; render(); });
    document.querySelector('.news-arrow--next')?.addEventListener('click', () => { i = (i + 1) % data.length; render(); });

    document.addEventListener('click', (e) => {
      const openBtn = e.target.closest('.news-btn');
      if (openBtn && !openBtn.hasAttribute('data-close')) {
        e.preventDefault();
        openModal(i);
      }

      if (e.target.closest('[data-close]')) {
        e.preventDefault();
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.hidden) closeModal();
    });

    render();
  })();
</script>










<script>
  (function () {
    const v = document.getElementById('heroVideo');
    const btn = document.getElementById('ppBtn');
    const hasSource = v.currentSrc || v.querySelector('source');

    if (!hasSource) {
      btn.disabled = true;
      btn.classList.add('is-disabled');
      return;
    }

    v.muted = true;

    const setState = playing => {
      btn.classList.toggle('is-playing', playing);
    };

    btn.addEventListener('click', () => {
      if (v.paused) {
        v.play().then(() => setState(true)).catch(() => { });
      } else {
        v.pause();
        setState(false);
      }
    });

    v.addEventListener('play', () => setState(true));
    v.addEventListener('pause', () => setState(false));
  })();
</script>

{% endblock %}