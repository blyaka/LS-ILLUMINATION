{% extends '_base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/home.css' %}" />
{% endblock %}

{% block content %}

<script src="{% static 'vendor/hls/hls.min.js' %}"></script>

<section class="ls-hero">
  {% if hero_video %}
  <video id="heroVideo" class="ls-hero__media" {% if hero_video.poster %}poster="{{ hero_video.poster.url }}" {% endif%} muted loop playsinline></video>

  <script>
    (function () {
      const src = "{{ hero_video.m3u8_url }}";
      const el = document.getElementById('heroVideo');

      function playNative() { el.src = src; }

      if (el.canPlayType('application/vnd.apple.mpegurl')) {
        playNative();
      } else if (window.Hls && Hls.isSupported()) {
        const h = new Hls({ maxBufferLength: 10 });
        h.loadSource(src);
        h.attachMedia(el);
      } else {
        playNative();
      }
    })();
  </script>
  {% endif %}



  <div class="ls-hero__overlay-top"></div>
  <div class="ls-hero__overlay-bottom"></div>

  <div class="ls-hero__content">
    <h1 class="ls-hero__title">Москва</h1>
    <p class="ls-hero__subtitle">Новогоднее оформление всей России</p>
  </div>

  <div class="ls-hero__stats">
    <div class="ls-hero__stat">
      <span>16</span><small>лет работы</small>
    </div>
    <div class="ls-hero__stat">
      <span>250+</span><small>проектов</small>
    </div>
    <div class="ls-hero__stat">
      <span>300+</span><small>человек</small>
    </div>
  </div>

  <button class="ls-hero__pp" id="ppBtn" aria-label="Воспроизвести/Пауза">
    <svg class="pp-icon pp-play" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
      <path d="M8 5v14l11-7-11-7z" fill="currentColor" />
    </svg>
    <svg class="pp-icon pp-pause" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
      <path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor" />
    </svg>
  </button>
</section>






<svg style="display: none">
  <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%" filterUnits="objectBoundingBox">
    <feTurbulence type="fractalNoise" baseFrequency="0.01 0.01" numOctaves="1" seed="1" result="turbulence" />

    <feComponentTransfer in="turbulence" result="mapped">
      <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
      <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
      <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
    </feComponentTransfer>

    <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

    <feSpecularLighting in="softMap" surfaceScale="5" specularConstant="1" specularExponent="100" lighting-color="white"
      result="specLight">
      <fePointLight x="-200" y="-200" z="300" />
    </feSpecularLighting>

    <feComposite in="specLight" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litImage" />

    <feDisplacementMap in="SourceGraphic" in2="softMap" scale="75" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>





<section class="cw-portfolio" id="portfolio">
  <h2 class="cw-portfolio__title">Портфолио</h2>

  <div class="cw-portfolio__grid">
    {% for cat in categories %}
    <a class="liquidGlass-wrapper" href="{% url 'portfolio' slug=cat.slug %}">
      <div class="liquidGlass-effect"></div>
      <div class="liquidGlass-tint"></div>
      <div class="liquidGlass-shine"></div>
      <div class="liquidGlass-text">
        <figure class="p-card__inner">
          <div class="p-card__photo">
            {% if cat.photo.url %}<img src="{{ cat.photo.url }}" alt="{{ cat.name }}" />{% endif %}
          </div>
          <figcaption class="p-card__cap">
            <span>{{ cat.first_word }}</span>
            <small>{{ cat.rest_words }}</small>
          </figcaption>
        </figure>
      </div>
    </a>
    {% endfor %}

  </div>
</section>







<section class="cw-videos" id="videos">
  <h2 class="cw-videos__title">Видеогалерея</h2>

  <div class="cw-videos__grid">
    {% for v in more_videos %}
    <button class="v-card" type="button" {% if v.m3u8_url %} data-src="{{ v.m3u8_url }}"
      data-title="{{ v.name|default:'Видео' }}"
      data-poster="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}" {% else %} disabled aria-disabled="true" title="Видео ещё не готово" {% endif %}>
      <div class="v-card__thumb">
        <img src="{% if v.poster %}{{ v.poster.url }}{% else %}{% static 'images/portfolio.jpg' %}{% endif %}"
          alt="{{ v.name|default:'Видео' }}" loading="lazy" />
        <span class="v-card__play" aria-hidden="true"></span>
      </div>
      <span class="v-card__title">{{ v.name|default:"Видео" }}</span>
    </button>
    {% empty %}
    <p>Видео пока нет.</p>
    {% endfor %}
  </div>

  <!-- Модалка-плеер -->
  <div class="v-modal" id="vModal" hidden>
    <div class="v-modal__backdrop" data-close></div>
    <div class="v-modal__dialog" role="dialog" aria-modal="true" aria-label="Видеоплеер">
      <button class="v-modal__close" type="button" data-close aria-label="Закрыть">×</button>
      <div class="v-modal__frame">
        <video id="vPlayer" controls playsinline preload="none"></video>
      </div>
      <div class="v-modal__title" id="vTitle"></div>
    </div>
  </div>
</section>


<script>
  (() => {
    if (window.__videoModalInit) return;
    window.__videoModalInit = true;

    const modal = document.getElementById('vModal');
    const player = document.getElementById('vPlayer');
    const titleEl = document.getElementById('vTitle');
    let hls = null;

    function attach(src, poster) {
      return new Promise((resolve) => {
        const url = String(src || '').trim();
        if (!url) return resolve(false);

        // cleanup
        try { player.pause(); } catch { }
        if (hls) { try { hls.destroy(); } catch { } hls = null; }
        player.removeAttribute('src'); player.load();

        // постер пока оставляем, уберём на первом кадре
        if (poster) player.setAttribute('poster', poster); else player.removeAttribute('poster');

        // общий «готово»
        const onReady = () => {
          // снимем постер как только пошёл первый кадр
          const onPlaying = () => { player.removeAttribute('poster'); player.removeEventListener('playing', onPlaying); };
          player.addEventListener('playing', onPlaying, { once: true });
          resolve(true);
        };

        // нативный HLS (Safari)
        if (player.canPlayType('application/vnd.apple.mpegurl')) {
          player.src = url;
          player.addEventListener('canplay', onReady, { once: true });
          return;
        }

        // hls.js
        if (window.Hls && Hls.isSupported()) {
          hls = new Hls({ maxBufferLength: 10, autoStartLoad: true });
          hls.on(Hls.Events.MANIFEST_PARSED, onReady);
          hls.on(Hls.Events.ERROR, (ev, data) => {
            // фатальные ошибки — попробуем мягко рестартнуть
            if (data?.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                default: try { hls.destroy(); } catch { }
              }
            }
          });
          hls.loadSource(url);
          hls.attachMedia(player);
          return;
        }

        // фолбэк (только там, где HLS нативен)
        player.src = url;
        player.addEventListener('canplay', onReady, { once: true });
      });
    }

    async function open(src, poster, title) {
      titleEl.textContent = title || '';
      modal.hidden = false;
      document.body.style.overflow = 'hidden';

      const ready = await attach(src, poster);
      if (!ready) return;

      // старт после готовности — теперь не залипает на постере
      player.muted = true;
      try { await player.play(); } catch { }
    }

    function close() {
      try { player.pause(); } catch { }
      if (hls) { try { hls.destroy(); } catch { } hls = null; }
      player.removeAttribute('src'); player.load();
      modal.hidden = true;
      document.body.style.overflow = '';
    }

    // открытие
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.v-card');
      if (btn && btn.dataset.src) {
        e.preventDefault();
        open(btn.dataset.src, btn.dataset.poster, btn.dataset.title);
      }
      if (e.target.hasAttribute('data-close')) close();
    });

    // esc
    document.addEventListener('keydown', (e) => {
      if (!modal.hidden && e.code === 'Escape') close();
    });

    // клик по бэкдропу
    modal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) close();
    });
  })();
</script>




<section class="cw-seq" id="seq">
  <div class="cw-seq__sticky">
    <canvas id="seqCanvas" aria-label="Scroll sequence"></canvas>

    <!-- Overlay -->
    <div class="seq-ov">
      <div class="seq-copy" id="seqCopy">
        <span class="seq-kicker">Фонтан</span>
        <h2 class="seq-title">«ТЕАТРАЛЬНЫЙ»</h2>
        <p class="seq-desc">
          Где дети считают звёзды.<br />
          Где взрослые снова верят в чудо.<br />
          Где вместе — теплее.
        </p>
      </div>

      <!-- Артикул: слева гаснет -->
      <div class="seq-art seq-art--right" id="artL">
        <span class="dot"></span> <span>Арт. 1337</span>
      </div>
      <!-- Артикул: справа появляется -->
      <div class="seq-art seq-art--left" id="artR">
        <span class="dot"></span> <span>Арт. 1337</span>
      </div>

      <!-- Схема: появляется на финальных кадрах -->
      <img class="seq-scheme" id="seqScheme" src="{% static 'images/scheme.png' %}" alt="Схема" />
    </div>
  </div>
</section>

<section class="cw-split" id="sd-section">
  <div class="cw-split__media">
    <video id="sdPreview" class="cw-split__video" autoplay muted loop playsinline preload="metadata"
      poster="{% static 'images/hero-bg.png' %}">
      <source src="{% static 'video/hero.MOV' %}" type="video/mp4" />
    </video>
  </div>

  <aside class="cw-split__aside">
    <h2 class="cw-split__title">Светодинамическая конструкция</h2>
    <p class="cw-split__desc">Световые конструкции с программируемыми эффектами: смена цвета, движение света, мигание.
      Для яркого оформления городских пространств.</p>
    <button class="cw-split__btn" data-open="#sdModal">Смотреть полностью</button>
  </aside>

  <!-- Модалка-плеер -->

</section>

<section class="cw-split right" id="sd-section">
  <aside class="cw-split__aside">
    <h2 class="cw-split__title">Светодинамическая конструкция</h2>
    <p class="cw-split__desc">Световые конструкции с программируемыми эффектами: смена цвета, движение света, мигание.
      Для яркого оформления городских пространств.</p>
    <button class="cw-split__btn" data-open="#sdModal">Смотреть полностью</button>
  </aside>

  <div class="cw-split__media">
    <video id="sdPreview" class="cw-split__video" autoplay muted loop playsinline preload="metadata"
      poster="{% static 'images/hero-bg.png' %}">
      <source src="{% static 'video/hero.MOV' %}" type="video/mp4" />
    </video>
  </div>

  <!-- Модалка-плеер -->

</section>





<section class="cw-news" id="news">
  <h2 class="cw-news__title">Новости</h2>

  <div class="news-wrap">
    <button class="news-arrow news-arrow--prev" aria-label="Назад"></button>

    <!-- Левое превью -->
    <figure class="news-side news-side--left">
      <img id="newsPrevImg" src="{% static 'images/portfolio.jpg' %}" alt="">
    </figure>

    <!-- Центральная карточка (Всегда на месте) -->
    <article class="news-main" aria-live="polite">
      <figure class="news-main__media">
        <span class="news-date" id="newsDate">{{ news.0.created_at|date:"d E Y"|upper }}</span>
        <img id="newsImg" src="{{ news.0.image.url }}" alt="">
      </figure>
      <aside class="news-main__aside">
        <h3 class="news-title" id="newsTitle">{{ news.0.title|linebreaksbr }}</h3>
        <p class="news-desc" id="newsDesc">
          {{ news.0.text|truncatewords:25 }}
        </p>
        <a class="news-btn" id="newsLink" href="#">Читать далее</a>
      </aside>
    </article>

    <!-- Правое превью -->
    <figure class="news-side news-side--right">
      {% if news|length > 1 %}
      <img id="newsNextImg" src="{{ news.1.image.url }}" alt="">
      {% endif %}
    </figure>

    <button class="news-arrow news-arrow--next" aria-label="Вперёд"></button>
  </div>

  <!-- Данные для слайдера -->
  <script id="newsData" type="application/json">
    [
      {% for n in news %}
      {
        "date":"{{ n.created_at|date:'d E Y'|upper }}",
        "title":"{{ n.title|escapejs }}",
        "desc":"{{ n.text|truncatewords:30|escapejs }}",
        "img":"{{ n.image.url }}",
        "body":"{{ n.text|linebreaksbr|escapejs }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  </script>

</section>

<!-- Модалка новостей -->
<div class="news-modal" id="newsModal" hidden>
  <div class="news-modal__backdrop" data-close></div>
  <div class="news-modal__dialog" role="dialog" aria-modal="true" aria-label="Новость">
    <button class="news-modal__close" type="button" data-close aria-label="Закрыть">×</button>

    <h3 class="news-modal__title" id="nmTitle"></h3>
    <div class="news-modal__date" id="nmDate"></div>

    <figure class="news-modal__media">
      <img id="nmImg" src="" alt="">
    </figure>

    <div class="news-modal__body" id="nmBody"></div>

    <button class="news-modal__btn" type="button" data-close>Закрыть</button>
  </div>
</div>



<section class="cw-trust" id="trust">
  <h2 class="cw-trust__title">Нам доверяют</h2>

  <div class="trust-view" id="trustView">
    <div class="trust-track" id="trustTrack">
      <div class="trust-item"><img src="{% static 'logos/moscow.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/spb.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/khimki.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/klin.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/labytnangi.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/nadym.png' %}" alt=""></div>
      <div class="trust-item"><img src="{% static 'logos/klin.png' %}" alt=""></div>
    </div>
  </div>
</section>



<script>
  (() => {
    const view = document.getElementById('trustView');
    const track = document.getElementById('trustTrack');
    if (!view || !track) return;

    const cfg = { cols: 7, gap: 56, min: 180, max: 300, speed: 0.7 };

    let itemW = 0, gap = cfg.gap, step = 0, offset = 0;
    let nodes = [], cycleLen = 0;

    function dupOnce() {
      const kids = Array.from(track.children);
      for (let t = 0; t < 20; t++) track.append(...kids.map(n => n.cloneNode(true)));
      nodes = Array.from(track.children);
    }

    let M = 0, idxH = -1;
    function findKhimki() {
      const kids = Array.from(track.children);
      M = kids.length / 2;
      for (let i = 0; i < M; i++) {
        const img = kids[i].querySelector('img');
        if (img && /khimki/i.test(img.src)) { idxH = i; break; }
      }
    }

    function setSize() {
      const pad = parseFloat(getComputedStyle(view).getPropertyValue('--pad')) || 0;
      const vw = view.clientWidth - pad * 2;

      gap = cfg.gap;
      itemW = (vw - gap * (cfg.cols - 1)) / cfg.cols;
      itemW = Math.max(cfg.min, Math.min(cfg.max, itemW));

      const need = itemW * cfg.cols + gap * (cfg.cols - 1);
      if (need > vw) {
        gap = Math.max(12, gap - (need - vw) / (cfg.cols - 1));
        itemW = (vw - gap * (cfg.cols - 1)) / cfg.cols;
      }

      step = itemW + gap;
      cycleLen = nodes.length / 2 * step;

      view.style.setProperty('--item', itemW + 'px');
      view.style.setProperty('--gap', gap + 'px');
    }

    function paint() {
      const cx = view.clientWidth / 2;
      const sigma = step * 0.9;
      const kMax = cfg.max / itemW;

      const M = nodes.length / 2;

      let sumExtra = 0;
      for (let j = 0; j < M; j++) {
        const center = offset + j * step + itemW / 2;
        const d = Math.abs(center - cx);
        const f = Math.exp(-(d * d) / (2 * sigma * sigma));
        const k = 1 + (kMax - 1) * f;
        sumExtra += (k - 1) * itemW / 2;
      }
      const liveCycleLen = M * (itemW + gap) + 2 * sumExtra;

      for (let i = 0; i < nodes.length; i++) {
        const center = offset + i * step + itemW / 2;
        const d = Math.abs(center - cx);
        const f = Math.exp(-(d * d) / (2 * sigma * sigma));
        const k = 1 + (kMax - 1) * f;
        const extra = (k - 1) * itemW / 2;
        const b = Math.pow(f, 6);

        nodes[i].style.setProperty('--k', k.toFixed(4));
        nodes[i].style.setProperty('--extra', extra.toFixed(2) + 'px');
        nodes[i].style.setProperty('--b', b.toFixed(4));
      }

      return liveCycleLen;
    }


    function frame() {
      offset -= cfg.speed;

      // безопасный wrap по базовой длине копии, как у тебя
      const L0 = (nodes.length / 2) * step;
      const cx = view.clientWidth / 2;
      const centerIdx = Math.round((cx - offset - itemW / 2) / step) % M;
      const norm = (centerIdx + M) % M;
      const safe = (idxH === -1) || (Math.abs(norm - idxH) > 2 && Math.abs(norm - (idxH + M)) > 2);
      if (offset <= -L0 && safe) offset += L0;

      // один раз за кадр считаем k/extra/b и получаем реальную длину
      const liveLen = paint();

      // лёгкий снап и один transform за кадр
      const x = Math.round(offset * 60) / 60;
      track.style.transform = `translate3d(${x}px,0,0)`;

      raf = requestAnimationFrame(frame);
    }



    dupOnce();
    findKhimki();
    setSize();
    view.style.setProperty('--max', cfg.max + 'px');

    const BASE_SPEED = 0.7; // фикс

    let raf = 0, running = false;
    function start() {
      if (running) return;
      running = true;
      cfg.speed = BASE_SPEED;  // всегда одна и та же
      offset = 0;              // чистый старт
      raf = requestAnimationFrame(frame);
    }
    function stop() {
      if (!running) return;
      running = false;
      cancelAnimationFrame(raf);
      raf = 0;
      cfg.speed = BASE_SPEED;  // сбросить на всякий
    }

    // наблюдаем блок: за 300px до появления — старт, ушёл — стоп
    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) start();
        else stop();
      }
    }, { root: null, rootMargin: '300px 0px 300px 0px', threshold: 0 });
    io.observe(view);

    // если вкладка скрыта — стоп, вернулся и блок рядом — старт
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) return stop();
      const r = view.getBoundingClientRect(), vh = innerHeight || document.documentElement.clientHeight;
      if (r.top < vh + 300 && r.bottom > -300) start();
    });

    // ресайз просто обновляет размеры (анимация продолжится сама если запущена)
    addEventListener('resize', setSize, { passive: true });



    // ховер-пауза (возвращаем ровно базовую скорость)
    view.addEventListener('mouseenter', () => { if (running) cfg.speed = 0 });
    view.addEventListener('mouseleave', () => { if (running) cfg.speed = 0.7 });

    // первый запуск если блок уже в зоне
    (() => {
      const r = view.getBoundingClientRect(), vh = innerHeight || document.documentElement.clientHeight;
      if (r.top < vh + 300 && r.bottom > -300) start();
    })();


  })();
</script>




<section class="cw-contacts" id="contacts" aria-label="Контакты">

  <div class="cw-contacts__wrap">
    <!-- Левая колонка: форма -->
    <div class="ct-form">
      <h2 class="ct-title">Мы на связи!</h2>
      <p class="ct-sub">Оставьте заявку или свяжитесь с нами</p>

      <form class="ct-grid-last" method="post" action="{% url 'req_submit' %}">
        {% csrf_token %}
        <input type="hidden" name="hp" value="">
        <input type="hidden" name="ts" value="{{ now_ts|default:0 }}">

        <label class="ct-field">
          <input type="text" name="name" placeholder="Ваше имя*" required>
        </label>

        <label class="ct-field">
          <input type="email" name="email" placeholder="Ваш E-mail*" required>
        </label>

        <label class="ct-field">
          <input type="tel" name="phone" inputmode="tel" placeholder="Ваш телефон*" required>
        </label>

        <label class="ct-area">
          <textarea name="message" rows="6" placeholder="Ваше сообщение"></textarea>
        </label>

        <button class="ct-btn" type="submit">Оставить заявку</button>
      </form>
    </div>


    <script>
      (function () {
        var f = document.querySelector('.ct-grid-last');
        if (!f) return;
        var ts = f.querySelector('input[name="ts"]');
        if (ts && (!ts.value || ts.value === "0")) ts.value = Math.floor(Date.now() / 1000);
      })();
    </script>


    <!-- Правая колонка: контакты -->
    <aside class="ct-info">
      <ul class="ct-list">
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="28" height="28">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-phone"></use>
            </svg>
          </span>
          <a href="tel:+78126420365">+7 (812) 642-03-65</a>
        </li>
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="28" height="26">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-mail"></use>
            </svg>
          </span>
          <a href="mailto:info@multidekor.ru">info@multidekor.ru</a>
        </li>
        <li>
          <span class="ct-ico" aria-hidden="true">
            <svg width="27" height="32">
              <use xlink:href="{% static 'images/icons.svg' %}#icon-location"></use>
            </svg>
          </span>
          г. Санкт-Петербург, улица Ломоносова, 28
        </li>
      </ul>

      <div class="ct-hours">
        <div class="ct-hours__ico" aria-hidden="true">
          <svg width="28" height="28">
            <use xlink:href="{% static 'images/icons.svg' %}#icon-time"></use>
          </svg>
        </div>
        <div class="ct-hours__text">
          <div>Пн-Пт с 10:00 до 18:00</div>
          <div class="muted">Сб-Вс — выходные дни</div>
        </div>
      </div>
    </aside>
  </div>
</section>





<script>
  (() => {
    const data = JSON.parse(document.getElementById('newsData').textContent);
    let i = 0;

    const img = document.getElementById('newsImg');
    const dateEl = document.getElementById('newsDate');
    const titleEl = document.getElementById('newsTitle');
    const descEl = document.getElementById('newsDesc');
    const prevImgEl = document.getElementById('newsPrevImg');
    const nextImgEl = document.getElementById('newsNextImg');

    const modal = document.getElementById('newsModal');
    const nmTitle = document.getElementById('nmTitle');
    const nmDate = document.getElementById('nmDate');
    const nmImg = document.getElementById('nmImg');
    const nmBody = document.getElementById('nmBody');

    const render = () => {
      const cur = data[i];
      const prev = data[(i - 1 + data.length) % data.length];
      const next = data[(i + 1) % data.length];
      img.src = cur.img;
      dateEl.innerHTML = cur.date;
      titleEl.innerHTML = cur.title;
      descEl.textContent = cur.desc;
      prevImgEl && (prevImgEl.src = prev.img);
      nextImgEl && (nextImgEl.src = next.img);
    };

    function openModal(idx) {
      if (!modal) return;
      const n = data[idx];
      nmTitle.textContent = n.title;
      nmDate.textContent = n.date;
      nmImg.src = n.img; nmImg.alt = n.title;
      nmBody.innerHTML = n.body;
      modal.hidden = false;
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      if (!modal) return;
      modal.hidden = true;
      document.body.style.overflow = '';
    }

    // стрелки
    document.querySelector('.news-arrow--prev')?.addEventListener('click', () => { i = (i - 1 + data.length) % data.length; render(); });
    document.querySelector('.news-arrow--next')?.addEventListener('click', () => { i = (i + 1) % data.length; render(); });

    // ЧИТАТЬ ДАЛЕЕ — делегирование (на случай перекрытий/рендеров)
    document.addEventListener('click', (e) => {
      const a = e.target.closest('.news-btn');
      if (a) { e.preventDefault(); openModal(i); }
      if (e.target.hasAttribute('data-close')) closeModal();
    });

    // ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.hidden) closeModal();
    });

    render();
  })();
</script>




<script>
  ; (() => {
    const open = (sel) => {
      const m = document.querySelector(sel)
      if (!m) return
      // пауза превью
      const prev = document.getElementById('sdPreview')
      prev && prev.pause()
      // открыть модалку
      m.hidden = false
      document.body.style.overflow = 'hidden'
      const full = document.getElementById('sdFull')
      full && full.play().catch(() => { })
    }

    const close = (m) => {
      const full = document.getElementById('sdFull')
      if (full) {
        full.pause() /* full.currentTime = 0; */
      }
      m.hidden = true
      document.body.style.overflow = ''
      // возобновим превью
      const prev = document.getElementById('sdPreview')
      prev && prev.play().catch(() => { })
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-open]')
      if (btn) {
        open(btn.dataset.open)
      }
      if (e.target.matches('[data-close]')) {
        close(e.target.closest('.sv-modal'))
      }
    })

    document.addEventListener('keydown', (e) => {
      const m = document.getElementById('sdModal')
      if (e.key === 'Escape' && m && !m.hidden) close(m)
    })

    // пауза превью, когда секция вне вьюпорта
    const io = new IntersectionObserver(
      ([ent]) => {
        const v = document.getElementById('sdPreview')
        if (!v) return
        if (ent.isIntersecting) v.play().catch(() => { })
        else v.pause()
      },
      { threshold: 0.2 }
    )
    io.observe(document.getElementById('sd-section'))
  })()
</script>

<script>
    (() => {
      const s = document.getElementById('seq');
      const c = document.getElementById('seqCanvas');
      const x = c.getContext('2d', { alpha: false });
      const d = Math.min(2, window.devicePixelRatio || 1);

      const copy = document.getElementById('seqCopy');
      const artL = document.getElementById('artL');
      const artR = document.getElementById('artR');
      const scheme = document.getElementById('seqScheme');
      const desc = document.querySelector('.seq-desc');

      const N = 60;
      const U = i => `/static/images/sequence/final_00000_${String(i).padStart(5, '0')}.webp`;
      const G = new Array(N);
      let tgt = 0, cur = 0, raf = 0, last = -1;

      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const ease = (t) => t < .5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;      // easeInOut
      const smooth = (a, b, t) => clamp((t - a) / (b - a), 0, 1);           // smoothstep 0..1

      function resize() {
        c.width = Math.floor(innerWidth * d);
        c.height = Math.floor(innerHeight * d);
        c.style.width = '100vw'; c.style.height = '100vh';
        x.setTransform(d, 0, 0, d, 0, 0);
        snap(cur);
      }

      function draw(img) {
        const cw = c.width / d, ch = c.height / d;
        const iw = img.naturalWidth, ih = img.naturalHeight;
        const s = Math.max(cw / iw, ch / ih), w = iw * s, h = ih * s;
        x.clearRect(0, 0, cw, ch);
        x.drawImage(img, (cw - w) / 2, (ch - h) / 2, w, h);
      }

      function snap(f) {
        const idx = clamp(Math.round(f), 0, N - 1);
        if (idx === last) return;
        const im = G[idx];
        if (!im || !im.complete) return;
        last = idx; draw(im);
      }

      function progressFromScroll() {
        const r = s.getBoundingClientRect();
        const m = s.offsetHeight - innerHeight;
        const y = Math.min(m, Math.max(0, -r.top));
        tgt = m ? (y / m) * (N - 1) : 0;
        if (!raf) raf = requestAnimationFrame(loop);
      }

      function updateOverlay(p) {
        // движение текста: вправо + вверх
        const t = ease(p);
        const moveX = innerWidth * 0.66;   // насколько уедет по X
        const moveY = innerHeight * 0.32;  // насколько поднимется по Y
        copy.style.transform = `translate(${moveX * t}px, ${-moveY * t}px)`;

        // артикул: слева гаснет 40–55%, справа появляется 55–70%
        artL.style.opacity = 1 - smooth(0.40, 0.55, p);
        artR.style.opacity = smooth(0.55, 0.70, p);

        // схема: появляется внизу справа на 80–95%
        const vis = smooth(0.80, 0.95, p);
        scheme.style.opacity = vis;
        scheme.style.transform = `translateY(${16 * (1 - vis)}px)`;

        // абзац к финалу выравниваем по правому краю
        <!-- desc.style.textAlign = p > 0.88 ? 'right' : 'left'; -->
      }


      function loop() {
        raf = 0;
        cur += (tgt - cur) * 0.2;     // плавное, но без «мыла»
        snap(cur);
        updateOverlay(cur / (N - 1));
        if (Math.abs(tgt - cur) > 0.001) raf = requestAnimationFrame(loop);
      }

      // preload
      G[0] = new Image(); G[0].src = U(0); G[0].onload = () => { snap(0); updateOverlay(0); };
      for (let i = 1; i < N; i++) { G[i] = new Image(); G[i].decoding = 'async'; G[i].src = U(i); }

      resize();
      addEventListener('resize', () => { resize(); progressFromScroll(); });
      addEventListener('scroll', progressFromScroll, { passive: true });
    })();
</script>




<script>
  (function () {
    const v = document.getElementById('heroVideo');
    const btn = document.getElementById('ppBtn');
    const hasSource = v.currentSrc || v.querySelector('source');

    if (!hasSource) {
      btn.disabled = true;
      btn.classList.add('is-disabled');
      return;
    }

    v.muted = true;

    const setState = playing => {
      btn.classList.toggle('is-playing', playing);
    };

    btn.addEventListener('click', () => {
      if (v.paused) {
        v.play().then(() => setState(true)).catch(() => { });
      } else {
        v.pause();
        setState(false);
      }
    });

    v.addEventListener('play', () => setState(true));
    v.addEventListener('pause', () => setState(false));
  })();
</script>

{% endblock %}